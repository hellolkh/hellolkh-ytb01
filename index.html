<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>YouTube 분석(ULTRA+ v3.3 · GitHub Pages)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{--bg:#0b1020;--card:#121834;--muted:#9fb0ff;--ink:#e9ecff;--line:#223;--accent:#6ea8ff;--warn:#ffb36e;--err:#ff6e6e}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--ink);margin:0}
    header{padding:20px;border-bottom:1px solid var(--line)}
    h1{font-size:20px;margin:0}
    .wrap{max-width:1400px;margin:0 auto;padding:20px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1 1 200px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,select,textarea,button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:#0f1530;color:#e9ecff}
    textarea{min-height:84px;resize:vertical}
    button{cursor:pointer;background:#1a2350}
    button.primary{background:var(--accent);color:#041024;border:none}
    .grid{overflow:auto;border:1px solid var(--line);border-radius:14px;max-height:60vh}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid #1d2548;vertical-align:middle}
    th{position:sticky;top:0;background:#0f1637;color:#cfe0ff;white-space:nowrap;cursor:pointer}
    tr:hover{background:#0e1431}
    .thumb{width:68px;height:38px;object-fit:cover;border-radius:6px;border:1px solid #222}
    .muted{color:#a8b4ff}
    .badge{display:inline-block;padding:2px 8px;border:1px solid #2a3a7a;border-radius:999px;font-size:11px;color:#bcd1ff}
    .footer{font-size:12px;color:#9fb0ff}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .item{flex:1 1 200px;background:#10183b;border:1px solid var(--line);border-radius:12px;padding:12px}
    .item b{display:block;font-size:18px;margin-bottom:4px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #2a3a7a;border-radius:999px;font-size:11px;color:#bcd1ff;margin-right:6px}
    .small{font-size:12px}
    .btns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
    .status{font-size:12px;color:#9fb0ff}
    .log{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;background:#0e1431;border:1px dashed #2a3566;border-radius:12px;padding:10px;max-height:160px;overflow:auto;color:#cfe0ff}
    .log b{color:#fff}
    .error{color:var(--err)}
    .spinner{display:none;margin-left:8px;border:3px solid #334; border-top:3px solid var(--accent); border-radius:50%; width:16px; height:16px; animation: spin 0.7s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .charts{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:900px){ .charts{grid-template-columns:1fr} }
    .notice{background:#0e173a;border:1px dashed #334;padding:12px;border-radius:10px;color:#cfe0ff}
    .notice code{background:#0b122f;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<header class="wrap">
  <h1>YouTube 분석(ULTRA+ v3.3 · GitHub Pages)</h1>
  <div class="notice">
    <div>이 버전은 GitHub Pages에서 바로 열리도록 최적화했어요. Google Cloud Console에서 <b>API 키 referrer</b>를 아래 패턴으로 허용해 주세요:</div>
    <div style="margin-top:6px"><code>https://*.github.io/*</code> 또는 <code>https://&lt;아이디&gt;.github.io/*</code> 또는 사용 중인 커스텀 도메인</div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row">
      <div>
        <label>API 키</label>
        <input id="apiKey" type="password" placeholder="직접 호출 모드에서만 필요">
      </div>
      <div>
        <label>호출 모드</label>
        <select id="mode"><option value="direct" selected>직접 호출</option><option value="proxy">프록시</option></select>
      </div>
      <div>
        <label>프록시 BASE URL</label>
        <input id="proxyBase" placeholder="https://your-worker.workers.dev/yt">
      </div>
      <div>
        <label>로컬 캐시 TTL(분)</label>
        <input id="ttl" type="number" value="60" min="0">
      </div>
    </div>

    <div class="row">
      <div>
        <label>키워드 목록</label>
        <textarea id="queries" placeholder="예)\n랜선정리\n사무실 와이파이 구축, 네트워크 공사"></textarea>
      </div>
      <div>
        <label>키워드당 수집 개수</label>
        <select id="limit"><option>20</option><option selected>50</option><option>80</option><option>100</option></select>
      </div>
      <div>
        <label>정렬 기준</label>
        <select id="sortKey">
          <option value="score">종합점수</option>
          <option value="viewsPerDay">조회수/일</option>
          <option value="viewPerSub">조회수/구독자</option>
          <option value="views">조회수</option>
          <option value="freshness">신선도</option>
          <option value="engage">참여율</option>
          <option value="published">업로드 시각</option>
        </select>
      </div>
      <div>
        <label>정렬 방향</label>
        <select id="sortDir"><option value="desc" selected>내림차</option><option value="asc">오름차</option></select>
      </div>
      <div>
        <label>조회기간</label>
        <select id="timeRange">
          <option value="all" selected>전체</option>
          <option value="1d">최근 1일</option>
          <option value="7d">최근 7일(주간)</option>
          <option value="30d">최근 30일(월간)</option>
        </select>
      </div>
      <div>
        <label>최소 조회수</label>
        <input id="minViews" type="number" value="0" min="0">
      </div>
    </div>

    <div class="row">
      <div>
        <label>점수 가중치 (조회수/일 %)</label>
        <input id="wVPD" type="number" value="60" min="0" max="100">
      </div>
      <div>
        <label>점수 가중치 (조회수/구독자 %)</label>
        <input id="wVPS" type="number" value="30" min="0" max="100">
      </div>
      <div>
        <label>점수 가중치 (신선도 %)</label>
        <input id="wFresh" type="number" value="10" min="0" max="100">
      </div>
      <div>
        <label>버스트 보정(최근 14일 가중) 0~2</label>
        <input id="burst" type="number" value="0.5" min="0" max="2" step="0.1">
      </div>
    </div>

    <div class="row">
      <div>
        <label>우선 채널(개인화 가중)</label>
        <input id="priorityChannels" placeholder="예: help해결사, Ubiquiti">
      </div>
      <div>
        <label>채널 포함</label>
        <input id="incChannel" placeholder="쉼표로 구분">
      </div>
      <div>
        <label>채널 제외</label>
        <input id="excChannel" placeholder="쉼표로 구분">
      </div>
      <div>
        <label>중복 제거</label>
        <select id="dedupe"><option value="on" selected>켜기</option><option value="off">끄기</option></select>
      </div>
    </div>

    <div class="btns">
      <button id="run" data-action="run" class="primary" onclick="window._runAll && window._runAll()">다중 키워드 실행</button>
      <button id="btnTest" title="API 연결 진단">연결 진단</button>
      <button id="saveCsv">CSV 저장</button>
      <button id="saveXls">엑셀 저장(xls)</button>
      <button id="saveThumbs">현재 목록 썸네일 모두 저장</button>
      <button id="saveCharts">차트 PNG 저장</button>
      <button id="printReport">리포트 인쇄</button>
      <div class="status">버튼 상태: <span id="btnState">대기</span></div>
      <div id="spin" class="spinner"></div>
    </div>
    <details class="log" id="logBox"><summary><b>로그 열기</b> — 오류/응답 메시지가 여기에 표시돼요</summary><pre id="log"></pre></details>
    <div class="footer">직접 호출 모드에서는 API 키 referrer를 <code>https://*.github.io/*</code> 로 허용해야 해요. 필요하면 프록시 모드를 써주세요.</div>
  </section>

  <section class="card">
    <div class="kpi" id="kpi"></div>
  </section>

  <section class="card">
    <div class="charts">
      <div>
        <label class="muted small">시간대 분포(0–23시, KST)</label>
        <canvas id="chartHour" width="560" height="320"></canvas>
      </div>
      <div>
        <label class="muted small">요일 분포(일–토, KST)</label>
        <canvas id="chartWeek" width="560" height="320"></canvas>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="row">
      <div style="flex:1 1 100%"><label class="muted">키워드 분석(정렬 가능)</label></div>
      <div>
        <label>보기</label>
        <select id="kwView"><option value="bar" selected>막대형 Top 30</option><option value="table">표 보기</option></select>
      </div>
      <div>
        <label>정렬 기준</label>
        <select id="kwSortKey"><option value="freq" selected>빈도</option><option value="name">가나다/알파벳</option></select>
      </div>
      <div>
        <label>정렬 방향</label>
        <select id="kwSortDir"><option value="desc" selected>내림차</option><option value="asc">오름차</option></select>
      </div>
    </div>
    <div id="kwBarWrap">
      <canvas id="kwBar" width="1120" height="400"></canvas>
    </div>
    <div id="kwTableWrap" style="display:none">
      <div class="grid">
        <table id="tblKeywords">
          <thead><tr><th>키워드</th><th>빈도</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="section-title">세부 목록</div>
    <div class="grid">
      <table id="tbl">
        <thead id="tblHead">
          <tr>
            <th data-key="rank">랭크</th>
            <th data-key="keyword">키워드</th>
            <th>썸네일</th>
            <th data-key="title">제목</th>
            <th data-key="channel">채널</th>
            <th data-key="published">업로드(KST)</th>
            <th data-key="weekday">요일</th>
            <th data-key="hour">시</th>
            <th data-key="views">조회수</th>
            <th data-key="likes">좋아요</th>
            <th data-key="comments">댓글</th>
            <th data-key="subscribers">구독자</th>
            <th data-key="channelVideoCount">채널영상수</th>
            <th data-key="viewsPerDay">조회/일</th>
            <th data-key="viewPerSub">조회/구독</th>
            <th data-key="engage">참여율</th>
            <th data-key="freshness">신선도</th>
            <th data-key="score">점수</th>
            <th>다운</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
const TIMEZONE_OFFSET_MIN = 9*60;
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const logEl = $('#log'), logBox = $('#logBox');
const spinner = $('#spin'); const btnState = $('#btnState');

function robustBind(){
  const runBtn = $('#run');
  if(runBtn){
    try{
      runBtn.addEventListener('click', ()=>{ btnState.textContent='클릭 인식됨'; }, { once:false });
      runBtn.addEventListener('click', runAll, { once:false });
      log('direct addEventListener OK');
    }catch(e){ log('direct addEventListener FAIL: ' + e.message, true); }
  }
  try{
    document.addEventListener('click', (ev)=>{
      const target = ev.target.closest('[data-action="run"]');
      if(target){ btnState.textContent='위임 클릭 인식됨'; runAll(); }
    });
    log('delegation OK');
  }catch(e){ log('delegation FAIL: ' + e.message, true); }
  window._runAll = function(){ btnState.textContent = 'fallback onclick 인식됨'; runAll(); };
}
document.addEventListener('DOMContentLoaded', robustBind);

document.addEventListener('DOMContentLoaded', ()=>{
  $('#saveCsv').addEventListener('click', saveCsv);
  $('#saveXls').addEventListener('click', saveXls);
  $('#saveThumbs').addEventListener('click', saveAllThumbs);
  $('#saveCharts').addEventListener('click', saveCharts);
  $('#printReport').addEventListener('click', ()=>window.print());
  $('#kwView').addEventListener('change', e=>{
    const v = e.target.value;
    $('#kwBarWrap').style.display = v==='bar' ? '' : 'none';
    $('#kwTableWrap').style.display = v==='table' ? '' : 'none';
  });
  $('#kwSortKey').addEventListener('change', ()=> renderKeywords(window.__rows||[]));
  $('#kwSortDir').addEventListener('change', ()=> renderKeywords(window.__rows||[]));
  $('#btnTest').addEventListener('click', connectionTest);
});

function setLoading(on){
  const btn=$('#run'); if(btn){ btn.disabled=on; btn.textContent = on?'실행 중...':'다중 키워드 실행'; }
  spinner.style.display = on ? 'inline-block' : 'none';
}
function log(msg, isErr=false){
  logEl.textContent += (isErr?'[ERR] ':'') + msg + '\\n';
  if(!logBox.open) logBox.open = true;
}
function persist(){
  const c = {
    apiKey: $('#apiKey').value.trim(), queries: $('#queries').value, limit: $('#limit').value,
    sortKey: $('#sortKey').value, sortDir: $('#sortDir').value, wVPD:+$('#wVPD').value, wVPS:+$('#wVPS').value, wFresh:+$('#wFresh').value,
    burst:+$('#burst').value, minViews:+$('#minViews').value, incChannel: $('#incChannel').value, excChannel: $('#excChannel').value,
    dedupe: $('#dedupe').value, priorityChannels: $('#priorityChannels').value, mode: $('#mode').value, proxyBase: $('#proxyBase').value, ttl:+$('#ttl').value,
    timeRange: $('#timeRange').value, kwSortKey: $('#kwSortKey').value, kwSortDir: $('#kwSortDir').value
  };
  localStorage.setItem('yt_html_tool_cfg_ultra_plus_pages', JSON.stringify(c));
}
(function restore(){
  const saved = localStorage.getItem('yt_html_tool_cfg_ultra_plus_pages');
  if(saved){
    try{
      const c = JSON.parse(saved);
      $('#apiKey').value = c.apiKey||''; $('#queries').value = c.queries||''; $('#limit').value = c.limit||'50';
      $('#sortKey').value = c.sortKey||'score'; $('#sortDir').value = c.sortDir||'desc';
      $('#wVPD').value = c.wVPD??60; $('#wVPS').value = c.wVPS??30; $('#wFresh').value = c.wFresh??10; $('#burst').value = c.burst??0.5;
      $('#minViews').value = c.minViews??0; $('#incChannel').value = c.incChannel||''; $('#excChannel').value = c.excChannel||'';
      $('#dedupe').value = c.dedupe||'on'; $('#priorityChannels').value = c.priorityChannels||''; $('#mode').value = c.mode||'direct';
      $('#proxyBase').value = c.proxyBase||''; $('#ttl').value = c.ttl??60;
      $('#timeRange').value = c.timeRange||'all'; $('#kwSortKey').value = c.kwSortKey||'freq'; $('#kwSortDir').value = c.kwSortDir||'desc';
    }catch(e){}
  }
})();

function apiBase(path){
  if($('#mode').value==='proxy'){
    const base = $('#proxyBase').value.trim().replace(/\/$/,'');
    return `${base}${path}`;
  }else{
    return `https://www.googleapis.com/youtube/v3${path}`;
  }
}
async function cachedFetch(url){
  const ttlMin = Number($('#ttl').value)||0;
  const key = 'cache:' + url;
  if(ttlMin>0){
    const raw = localStorage.getItem(key);
    if(raw){
      try{
        const obj = JSON.parse(raw);
        if(Date.now() - obj.t <= ttlMin*60000){ log('cache hit: ' + url); return obj.d; }
        else localStorage.removeItem(key);
      }catch(e){ localStorage.removeItem(key); }
    }
  }
  log('fetch: ' + url);
  const res = await fetch(url);
  if(!res.ok){
    let text=''; try{ text = await res.text(); }catch(e){}
    log(`HTTP ${res.status} ${res.statusText} — ${text.substring(0,300)}`, true);
    throw new Error(`HTTP ${res.status}`);
  }
  const data = await res.json();
  if(ttlMin>0){ localStorage.setItem(key, JSON.stringify({t:Date.now(), d:data})); }
  return data;
}

async function searchVideos(query, maxResults, key){
  let ids = [], pageToken='';
  while(ids.length < maxResults){
    const perPage = Math.min(50, maxResults - ids.length);
    const u = new URL(apiBase('/search'));
    u.search = new URLSearchParams({part:'snippet',type:'video',order:'date',maxResults:String(perPage),q:query});
    if($('#mode').value==='direct') u.searchParams.set('key', key);
    if(pageToken) u.searchParams.set('pageToken', pageToken);
    const data = await cachedFetch(u.toString());
    (data.items||[]).forEach(it=>{ const vid = it?.id?.videoId; if(vid) ids.push(vid); });
    pageToken = data.nextPageToken || ''; if(!pageToken) break;
  }
  return ids;
}
async function getVideos(videoIds, key){
  const out = [];
  for(let i=0;i<videoIds.length;i+=50){
    const batch = videoIds.slice(i,i+50);
    const u = new URL(apiBase('/videos'));
    u.search = new URLSearchParams({part:'snippet,statistics', id: batch.join(',')});
    if($('#mode').value==='direct') u.searchParams.set('key', key);
    const data = await cachedFetch(u.toString());
    (data.items||[]).forEach(it=>{
      const sn = it.snippet||{}, st = it.statistics||{}, th = sn.thumbnails||{};
      const thumb = th.maxres?.url || th.high?.url || th.medium?.url || th.default?.url || '';
      out.push({ id: it.id, title: sn.title||'', channelId: sn.channelId||'', channel: sn.channelTitle||'', publishedAt: sn.publishedAt||'', views:+st.viewCount||0, likes:+st.likeCount||0, comments:+st.commentCount||0, thumb });
    });
  }
  return out;
}
async function getChannels(channelIds, key){
  const out = {};
  for(let i=0;i<channelIds.length;i+=50){
    const batch = channelIds.slice(i,i+50);
    const u = new URL(apiBase('/channels'));
    u.search = new URLSearchParams({part:'snippet,statistics', id: batch.join(',')});
    if($('#mode').value==='direct') u.searchParams.set('key', key);
    const data = await cachedFetch(u.toString());
    (data.items||[]).forEach(it=>{
      const st = it.statistics||{};
      out[it.id] = { title: it?.snippet?.title || '', subscribers: st.hiddenSubscriberCount ? 0 : (+st.subscriberCount||0), videoCount: +st.videoCount||0 };
    });
  }
  return out;
}

async function connectionTest(){
  persist();
  setLoading(true);
  try{
    const apiKey = $('#apiKey').value.trim();
    const u = new URL(apiBase('/search'));
    u.search = new URLSearchParams({part:'snippet',type:'video',maxResults:'1',q:'test'});
    if($('#mode').value==='direct'){
      if(!apiKey){ alert('직접 호출 모드에서는 API 키가 필요해요'); setLoading(false); return; }
      u.searchParams.set('key', apiKey);
    }
    const data = await cachedFetch(u.toString());
    log('진단 성공: search OK, items=' + (data.items?.length||0));
    alert('진단 성공: API 연결에 문제가 없어 보여요');
  }catch(e){
    alert('진단 실패: 로그를 확인하세요');
  }finally{ setLoading(false); }
}

async function runAll(){
  persist();
  const apiKey = $('#apiKey').value.trim();
  const qs = $('#queries').value.split(/[\n,]/).map(x=>x.trim()).filter(Boolean);
  const max = Number($('#limit').value);
  if($('#mode').value==='direct' && !apiKey){ alert('직접 호출 모드에서는 API 키가 필요해요'); return; }
  if(!qs.length){ alert('키워드를 입력하세요'); return; }
  setLoading(true);
  try{
    log('=== 실행 시작 ===');
    const seen = new Set();
    const allRows = [];
    for(const q of qs){
      log('검색: ' + q);
      const ids = await searchVideos(q, max, apiKey);
      log('videoIds: ' + ids.length);
      const vids = await getVideos(ids, apiKey);
      const chIds = [...new Set(vids.map(v=>v.channelId).filter(Boolean))];
      log('채널 수: ' + chIds.length);
      const chMap = await getChannels(chIds, apiKey);
      const rows = mergeAndScore(vids, chMap, q);
      for(const r of rows){
        if($('#dedupe').value==='on'){ if(seen.has(r.videoId)) continue; seen.add(r.videoId); }
        allRows.push(r);
      }
    }
    const filtered = applyFilters(allRows);
    log('필터 후 행: ' + filtered.length);
    renderTable(filtered);
    drawCharts(filtered);
    renderKeywords(filtered);
    log('=== 완료 ===');
  }catch(err){
    console.error(err);
    alert('에러: ' + (err?.message || err));
  }finally{ setLoading(false); }
}

function mergeAndScore(videos, channelMap, keyword){
  const wVPD=+$('#wVPD').value/100, wVPS=+$('#wVPS').value/100, wFresh=+$('#wFresh').value/100, burst=+$('#burst').value;
  const norm = x => x<=0 ? 0 : Math.min(Math.log10(1+x)/6, 1);
  const freshness = d => Math.pow(0.5, d/90);
  const now = new Date();
  return videos.map(v=>{
    const ch = channelMap[v.channelId] || {title:v.channel, subscribers:0, videoCount:0};
    const days = Math.max(1, Math.floor((now - new Date(v.publishedAt)) / 86400000));
    const vpd = v.views / days, vps = ch.subscribers>0 ? v.views/ch.subscribers : 0;
    let fresh = freshness(days); if(days<=14) fresh = Math.min(1, fresh + burst*(14-days)/14);
    const engage = (v.likes + v.comments) / Math.max(1, v.views);
    const kst = toKST(new Date(v.publishedAt));
    const yyyy=kst.getFullYear(), mm=String(kst.getMonth()+1).padStart(2,'0'), dd=String(kst.getDate()).padStart(2,'0');
    const hh=String(kst.getHours()).padStart(2,'0'), mi=String(kst.getMinutes()).padStart(2,'0'), ss=String(kst.getSeconds()).padStart(2,'0');
    const weekday = ['일','월','화','수','목','금','토'][kst.getDay()];
    const score = norm(vpd)*wVPD + norm(vps)*wVPS + fresh*wFresh;
    return { keyword, videoId:v.id, videoUrl:`https://www.youtube.com/watch?v=${v.id}`, channelUrl:`https://www.youtube.com/channel/${v.channelId}`,
      title:v.title, channel: ch.title || v.channel, publishedKst:`${yyyy}-${mm}-${dd} ${hh}:${mi}:${ss}`, weekday, hour:+hh,
      views:v.views, likes:v.likes, comments:v.comments, subscribers:ch.subscribers, channelVideoCount:ch.videoCount,
      viewsPerDay:Math.round(vpd*100)/100, viewPerSub:+vps.toFixed(4), engage:+engage.toFixed(4), freshness:+fresh.toFixed(4), score:+score.toFixed(4), thumb:v.thumb,
      published: +new Date(`${yyyy}-${mm}-${dd}T${hh}:${mi}:${ss}+09:00`)
    };
  });
}
function toKST(dUtc){ return new Date(dUtc.getTime() + TIMEZONE_OFFSET_MIN*60000); }

function applyFilters(rows){
  let r = rows.slice();
  const inc=split($('#incChannel').value), exc=split($('#excChannel').value), minViews=+$('#minViews').value||0;
  if(inc.length) r=r.filter(x=> inc.some(t=> (x.channel||'').toLowerCase().includes(t)) );
  if(exc.length) r=r.filter(x=> !exc.some(t=> (x.channel||'').toLowerCase()).includes(t) );
  if(minViews>0) r=r.filter(x=> x.views>=minViews);

  const tr = $('#timeRange').value;
  if(tr!=='all'){
    let days = tr==='1d' ? 1 : tr==='7d' ? 7 : 30;
    const cutoff = Date.now() - days*86400000;
    r = r.filter(x=> x.published >= cutoff);
  }
  return sortRows(r);
}
function split(s){ return s.split(',').map(x=>x.trim().toLowerCase()).filter(Boolean); }
function sortRows(r){
  const key=$('#sortKey').value, dir=$('#sortDir').value;
  const s = (a,b)=>{
    let va=a[key], vb=b[key];
    if(key==='title'||key==='channel'||key==='keyword'||key==='weekday') { va=String(va); vb=String(vb); }
    if(key==='published'){ va=a.published; vb=b.published; }
    if(va<vb) return dir==='asc'?-1:1;
    if(va>vb) return dir==='asc'?1:-1;
    return 0;
  };
  r.sort(s); return r;
}

function renderTable(rows){
  window.__rows = rows;
  const kpi=$('#kpi');
  if(!rows.length){ kpi.innerHTML='<div class="item">결과 없음</div>'; $('#tbl tbody').innerHTML=''; return; }
  const avg = arr => arr.reduce((a,b)=>a+b,0)/arr.length;
  const top = rows[0];
  const kwSet=new Set(rows.map(r=>r.keyword));
  kpi.innerHTML = `
    <div class="item"><b>${rows.length.toLocaleString()}</b><span class="muted">수집 영상</span><div>${[...kwSet].slice(0,8).map(k=>`<span class="pill">${escapeHtml(k)}</span>`).join(' ')}${kwSet.size>8?'…':''}</div></div>
    <div class="item"><b>${Math.round(avg(rows.map(r=>r.viewsPerDay))).toLocaleString()}</b><span class="muted">평균 조회/일</span></div>
    <div class="item"><b>${(avg(rows.map(r=>r.viewPerSub))||0).toFixed(3)}</b><span class="muted">평균 조회/구독</span></div>
    <div class="item"><b>${(avg(rows.map(r=>r.engage))||0).toFixed(3)}</b><span class="muted">평균 참여율</span></div>
    <div class="item"><b>${top.weekday} ${top.hour}시</b><span class="muted">Top 업로드 시간대(1위 영상)</span></div>
  `;
  const tbody = $('#tbl tbody'); tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${escapeHtml(r.keyword)}</td>
      <td><a href="${r.videoUrl}" target="_blank" rel="noopener"><img class="thumb" src="${r.thumb}" alt=""></a></td>
      <td><a href="${r.videoUrl}" target="_blank" rel="noopener">${escapeHtml(r.title)}</a></td>
      <td><a href="${r.channelUrl}" target="_blank" rel="noopener" class="badge">${escapeHtml(r.channel)}</a></td>
      <td class="muted">${r.publishedKst}</td>
      <td>${r.weekday}</td>
      <td>${r.hour}</td>
      <td>${r.views.toLocaleString()}</td>
      <td>${r.likes.toLocaleString()}</td>
      <td>${r.comments.toLocaleString()}</td>
      <td>${r.subscribers.toLocaleString()}</td>
      <td>${r.channelVideoCount.toLocaleString()}</td>
      <td>${r.viewsPerDay.toLocaleString()}</td>
      <td>${r.viewPerSub}</td>
      <td>${r.engage}</td>
      <td>${r.freshness}</td>
      <td><b>${r.score}</b></td>
      <td><a class="dlbtn" href="${r.thumb}" download="${r.videoId}.jpg">썸네일</a></td>
    `;
    tbody.appendChild(tr);
  });

  $$('#tblHead th[data-key]').forEach(th=>{
    th.onclick = ()=>{
      const k = th.getAttribute('data-key');
      if($('#sortKey').value===k){
        $('#sortDir').value = $('#sortDir').value==='asc'?'desc':'asc';
      }else{
        $('#sortKey').value = k;
        $('#sortDir').value = 'desc';
      }
      const sorted = sortRows(window.__rows.slice());
      renderTable(sorted);
      renderKeywords(sorted);
      drawCharts(sorted);
    };
  });
}

function renderKeywords(rows){
  const text = rows.map(r=>r.title).join(' ').toLowerCase();
  const tokens = (text.match(/[0-9a-zA-Z]+|[가-힣]{2,}/g) || []).filter(w=>w.length>=2);
  const stop = new Set(['영상','채널','공식','소개','방법','가이드','모음','비교','리뷰','업로드','실시간','하이라이트','최신','업데이트','무료','추천','필수','초보','기초','asmr','노래','뮤직','ost','라이브','live','official','video','the','a','an','and','or','for','with','from','of','to','in','on','by','part','ep','full','hd','4k']);
  const filtered = tokens.filter(t=>!stop.has(t));
  const freq = new Map(); filtered.forEach(t=>freq.set(t,(freq.get(t)||0)+1));
  let arr = [...freq.entries()];
  const mode = $('#kwSortKey').value; const dir = $('#kwSortDir').value;
  arr.sort((a,b)=>{
    if(mode==='name'){ const va=a[0], vb=b[0]; if(va<vb) return dir==='asc'?-1:1; if(va>vb) return dir==='asc'?1:-1; return 0; }
    const va=a[1], vb=b[1]; if(va<vb) return dir==='asc'?-1:1; if(va>vb) return dir==='asc'?1:-1; return 0;
  });
  const top = arr.slice(0,30);
  const tbody = $('#tblKeywords tbody'); if(tbody){ tbody.innerHTML=''; top.forEach(([k,v])=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${escapeHtml(k)}</td><td>${v}</td>`; tbody.appendChild(tr); }); }
  const labels = top.map(([k])=>k), values = top.map(([_,v])=>v);
  drawBar($('#kwBar'), values, labels, `제목 키워드 Top 30 (${mode==='name'?'이름순':'빈도순'} · ${dir==='asc'?'오름':'내림'})`);
}

function drawBar(canvas, values, labels, title){
  const ctx = canvas.getContext('2d');
  const W=canvas.width, H=canvas.height;
  ctx.clearRect(0,0,W,H);
  const padL=140, padR=10, padT=30, padB=20;
  ctx.fillStyle='#cfe0ff'; ctx.font='16px system-ui'; ctx.fillText(title, padL, 22);
  const n=values.length; const gap=6, barH=(H - padT - padB - gap*(n+1))/n;
  const maxV=Math.max(1,Math.max(...values));
  for(let i=0;i<n;i++){
    const val=values[i];
    const w=(W - padL - padR) * (val/maxV);
    const x=padL, y=padT + gap + i*(barH+gap);
    ctx.fillStyle='#6ea8ff'; ctx.fillRect(x, y, w, barH);
    ctx.fillStyle='#9fb0ff'; ctx.font='14px system-ui';
    const lbl=labels[i]; const tw=ctx.measureText(lbl).width;
    ctx.fillText(lbl, x - 8 - Math.min(tw, padL-16), y + barH*0.7);
    ctx.fillStyle='#e9ecff'; ctx.font='14px system-ui';
    const vs=String(val); ctx.fillText(vs, x + w + 6, y + barH*0.7);
  }
}

function saveCsv(){
  const rows = window.__rows || []; if(!rows.length){ alert('저장할 데이터가 없어요'); return; }
  const header = ['rank','keyword','title','video_url','channel','channel_url','published_kst','weekday','hour','views','likes','comments','subscribers','channel_video_count','views_per_day','view_per_sub','engage','freshness','score','thumbnail','video_id'];
  const lines=[header.join(',')];
  rows.forEach((r,i)=>{
    const line=[i+1,csv(r.keyword),csv(r.title),r.videoUrl,csv(r.channel),r.channelUrl,r.publishedKst,r.weekday,r.hour,r.views,r.likes,r.comments,r.subscribers,r.channelVideoCount,r.viewsPerDay,r.viewPerSub,r.engage,r.freshness,r.score,r.thumb,r.videoId].join(',');
    lines.push(line);
  });
  const blob=new Blob([lines.join('\\n')],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='youtube_analysis_ultra_plus_pages.csv'; a.click(); URL.revokeObjectURL(url);
}
function saveXls(){
  const rows = window.__rows || []; if(!rows.length){ alert('저장할 데이터가 없어요'); return; }
  const esc = s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  let html='<!DOCTYPE html><html><head><meta charset="utf-8"></head><body><table border="1"><tr>' +
    ['랭크','키워드','제목','영상URL','채널','채널URL','업로드KST','요일','시','조회수','좋아요','댓글','구독자','채널영상수','조회/일','조회/구독','참여율','신선도','점수','썸네일URL','영상ID']
    .map(h=>`<th>${h}</th>`).join('') + '</tr>';
  (rows).forEach((r,i)=>{
    html += '<tr>' + [
      i+1, esc(r.keyword), esc(r.title), r.videoUrl, esc(r.channel), r.channelUrl, r.publishedKst, r.weekday, r.hour,
      r.views, r.likes, r.comments, r.subscribers, r.channelVideoCount, r.viewsPerDay, r.viewPerSub, r.engage, r.freshness, r.score, r.thumb, r.videoId
    ].map(x=>`<td>${x}</td>`).join('') + '</tr>';
  });
  html += '</table></body></html>';
  const blob = new Blob([html], {type:'application/vnd.ms-excel'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='youtube_analysis_ultra_plus_pages.xls'; a.click(); URL.revokeObjectURL(url);
}
function saveCharts(){
  const c1=$('#chartHour'), c2=$('#chartWeek'), c3=$('#kwBar');
  const W=Math.max(c1.width,c2.width,c3.width), H=c1.height+c2.height+c3.height+30;
  const combo=document.createElement('canvas'); combo.width=W; combo.height=H;
  const ctx=combo.getContext('2d'); ctx.fillStyle='#0b1020'; ctx.fillRect(0,0,W,H);
  let y=10; ctx.drawImage(c1,0,y); y+=c1.height+10; ctx.drawImage(c2,0,y); y+=c2.height+10; ctx.drawImage(c3,0,y);
  const url=combo.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='charts_pages.png'; a.click();
}
async function saveAllThumbs(){
  const rows=window.__rows||[]; if(!rows.length){ alert('목록이 비어 있어요'); return; }
  let count=0;
  for(const r of rows){
    try{
      const a=document.createElement('a'); a.href=r.thumb; a.download=`${r.videoId}.jpg`; document.body.appendChild(a); a.click(); a.remove();
      await new Promise(res=>setTimeout(res, 150));
      count++;
    }catch(e){}
  }
  alert(`썸네일 ${count}개 저장을 요청했어요. 브라우저 설정에 따라 자동 저장/승인 창이 뜰 수 있어요.`);
}
function csv(s){ if(s==null) return ''; s=String(s).replace(/"/g,'""'); if(s.includes(',')||s.includes('"')||s.includes('\\n')) return `"${s}"`; return s; }
function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;' }[m])); }

function drawCharts(rows){
  const hours = new Array(24).fill(0); rows.forEach(r=>{ if(r.hour>=0 && r.hour<=23) hours[r.hour]++; });
  barChart($('#chartHour'), hours, Array.from({length:24},(_,i)=>String(i)), '시간대별 업로드 개수');
  const map={'일':0,'월':0,'화':0,'수':0,'목':0,'금':0,'토':0}; rows.forEach(r=>{ if(map.hasOwnProperty(r.weekday)) map[r.weekday]++; });
  const labels=Object.keys(map), values=labels.map(k=>map[k]); barChart($('#chartWeek'), values, labels, '요일별 업로드 개수');
}
function barChart(canvas, values, labels, title){
  const ctx=canvas.getContext('2d'); const W=canvas.width,H=canvas.height;
  ctx.clearRect(0,0,W,H);
  const padL=40,padR=10,padT=30,padB=30; ctx.fillStyle='#cfe0ff'; ctx.font='14px system-ui'; ctx.fillText(title,padL,20);
  const maxV=Math.max(1,Math.max(...values)); const x0=padL,y0=H-padB,x1=W-padR,y1=padT;
  ctx.strokeStyle='#2a3466'; ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y0); ctx.moveTo(x0,y0); ctx.lineTo(x0,y1); ctx.stroke();
  const n=values.length,gap=4,barW=(x1-x0-gap*(n+1))/n;
  for(let i=0;i<n;i++){ const v=values[i],h=(v/maxV)*(y0-y1-4),x=x0+gap+i*(barW+gap),y=y0-h;
    ctx.fillStyle='#6ea8ff'; ctx.fillRect(x,y,barW,h);
    ctx.fillStyle='#9fb0ff'; ctx.font='12px system-ui'; const lbl=labels[i]; const tw=ctx.measureText(lbl).width; ctx.fillText(lbl,x+barW/2-tw/2,y0+14);
    ctx.fillStyle='#e9ecff'; const vs=String(v); const vw=ctx.measureText(vs).width; ctx.fillText(vs, x+barW/2 - vw/2, y-4);
  }
}
</script>
</body>
</html>
